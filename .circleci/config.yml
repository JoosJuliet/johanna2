# Python CircleCI 2.0 configuration file
#
# Check https://circleci.com/docs/2.0/language-python/ for more details
#
version: 2
jobs:
  build:
    docker:
      - image: circleci/python:3.7.4
        environment:
          PIPENV_VENV_IN_PROJECT: true
          DATABASE_URL: mysql://root@localhost/server?sslmode=disable
      - image: circleci/mysql:8.0-ram
        environment:
          MYSQL_USER: root
          MYSQL_DATABASE: server

    working_directory: ~/server

    steps:
      - checkout
      - run: sudo chown -R circleci:circleci /usr/local/bin
      - run: sudo chown -R circleci:circleci /usr/local/lib/python3.7/site-packages
      - restore_cache:  # ensure this step occurs *before* installing dependencies
          key: deps9-{{ .Branch }}-{{ checksum "Pipfile.lock" }}
      - run:
          name: run tests with pipenv
          command: |
            sudo pip install pipenv
            pipenv install
            pipenv run pytest --cov=server
            pipenv run codecov --token=1ee9f37c-2294-425b-8cd0-cc5ec9c78162
          environment:
            DJANGO_SETTINGS_MODULE: server.settings.test
      - save_cache:
          key: deps9-{{ .Branch }}-{{ checksum "Pipfile.lock" }}
          paths:
            - "/usr/local/bin"
            - "/usr/local/lib/python3.7/site-packages"
            -
  deploy:
    machine:
      enabled: true
    working_directory: ~/server
    environment:
      PIPENV_VENV_IN_PROJECT: true
      DJANGO_SETTINGS_MODULE: server.settings.production
    steps:
      - checkout
      - run:
          name: Deploy Master to Zappa
          command: |
            pipenv run zappa update production

workflows:
  version: 2
  build-deploy:
    jobs:
      - build
      - deploy:
          requires:
            - build
          filters:
            branches:
              only: master
